@inherits InputTextArea
@inject IJSRuntime JSRuntime

@{ 
/*

IMPORTANT: This component should be called inside an EditForm   
*/
}

<textarea @attributes="AdditionalAttributes"
          id="@Id"
          class="@CssClass"
          value="@CurrentValue"></textarea>


@code {
    string _id;
    [Parameter]
    public string Id
    {
        get => _id ?? $"CKEditor_{uid}";
        set => _id = value;
    }


    [Parameter] 
    public EventCallback<string> OnSave { get; set; }


    readonly string uid = Guid.NewGuid().ToString().ToLower().Replace("-", "");

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        /*
            CKEditorInterop.init = @CKEditorInterop.js
            DotNetObjectReference.Create(this) = create instance of DotNetReference
            this = current Class Object
         */

        if (firstRender)
            await JSRuntime.InvokeVoidAsync("CKEditorInterop.init", Id, DotNetObjectReference.Create(this));

        await base.OnAfterRenderAsync(firstRender);
    }

    [JSInvokable]
    public Task EditorDataChanged(string data)
    {
        CurrentValue = data;
        StateHasChanged();
        return Task.CompletedTask;
    }

    [JSInvokable]
    public async Task EditorAutoSave(string data)
    {
        await OnSave.InvokeAsync(data);
    }

    protected override void Dispose(bool disposing)
    {
        JSRuntime.InvokeVoidAsync("CKEditorInterop.destroy", Id);
        base.Dispose(disposing);
    }
}